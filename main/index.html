<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<link rel="icon" type="image/x-icon" href="images/favicon.ico">
<title>XCP and FMI 3.0</title>
<style>

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/styles/github.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>XCP and FMI 3.0</h1>
<div class="details">
<span id="revnumber">version main-5dd815759798bc25a7f777e9c7824602cebc0610,</span>
<span id="revdate">2022-09-27</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">1. Introduction</a>
<ul class="sectlevel2">
<li><a href="#_intend_of_this_document">1.1. Intend of this Document</a></li>
<li><a href="#_rough_outline_of_the_approach">1.2. Rough Outline of the Approach</a></li>
<li><a href="#_comments_about_this_approach">1.3. Comments about this Approach</a></li>
</ul>
</li>
<li><a href="#_details">2. Details</a>
<ul class="sectlevel2">
<li><a href="#_structure_of_the_fmu_archive">2.1. Structure of the FMU archive</a></li>
<li><a href="#_documentation">2.2. Documentation</a></li>
<li><a href="#_a2l_description_files">2.3. A2L Description Files</a></li>
<li><a href="#_xcp_protocol_settings">2.4. XCP Protocol Settings</a></li>
<li><a href="#_xcp_slave_implementation">2.5. XCP Slave Implementation</a></li>
<li><a href="#_source_code_fmus">2.6. Source Code FMUs</a></li>
<li><a href="#_variable_visibility">2.7. Variable Visibility</a></li>
<li><a href="#_numeric_effects_of_xcp_access">2.8. Numeric Effects of XCP Access</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This layered standard defines, based on FMI 3.0, how to describe and implement XCP support for FMUs.</p>
</div>
<div class="paragraph">
<p><br>
</p>
</div>
<div class="paragraph">
<p>Copyright &#169; 2012-2022 The Modelica Association Project FMI.</p>
</div>
<div class="paragraph">
<p>This document is licensed under the Attribution-ShareAlike 4.0 International license.
The code is released under the 2-Clause BSD License.
The licenses text can be found in the <a href="https://raw.githubusercontent.com/modelica/fmi-standard/master/LICENSE.txt">LICENSE.txt</a> file that accompanies this distribution.</p>
</div>
<div class="paragraph">
<p></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_intend_of_this_document">1.1. Intend of this Document</h3>
<div class="paragraph">
<p>FMI 3.0 was extended also with virtual Electronic Control Units (virtual ECUs) in mind.
Engineers can measure into ECUs using the XCP protocol and A2L variable descriptions:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The ASAM MCD-1 XCP (Universal Measurement and Calibration Protocol) standard defines a bus-independent, master-slave communication protocol to connect ECUs with calibration systems.
XCP is short for Universal Measurement and Calibration Protocol.
The primary purpose of XCP is to adjust internal parameters and acquire the current values of internal variables of an ECU.
The first letter X in XCP expresses the fact that the protocol is designed for a variety of bus systems.
The standard consists of a base standard, which describes memory-oriented protocol services without direct dependencies on specific bus systems.
Several associate standards contain the transport layer definitions for CAN, FlexRay, Ethernet (UDP/IP and TCP/IP), serial links (SPI and SCI) and USB.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; ASAM e.V.<br>
<cite>https://www.asam.net/standards/detail/mcd-1-xcp/[ASAM MCD-1 XCP]</cite>
</div>
</div>
<div class="paragraph">
<p>This layered standard describes how an FMU advertises its XCP capabilities to importers and MCD tools using the XCP protocol.</p>
</div>
</div>
<div class="sect2">
<h3 id="_rough_outline_of_the_approach">1.2. Rough Outline of the Approach</h3>
<div class="paragraph">
<p>The FMU implements an XCP slave which provides access to measurement and calibration variables of the virtual ECU and handles the communication protocol with the XCP master in the MCD tool.
The necessary information for an MCD tool is given in a description file which follows the <a href="https://www.asam.net/standards/detail/mcd-2-mc/">ASAM MCD-2 MC</a> standard (aka <code>A2L</code>, also <code>ASAP2</code>) and customarily carries the file extension <code>.a2l</code>.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>ASAM MCD-2 MC (aka ASAP2) defines the description format of the internal ECU variables used in measurement and calibration.
Measurement &amp; calibration systems (MC-systems) require this description for both the parameterization of scalar constants, curves and maps of the ECU software and for recording the system&#8217;s response via measurement variables during real-time testing.
The description contains information about data types, dimensions, record layouts and memory locations of ECU variables.
The standard also describes how the variable values are converted into human-readable quantities and displayed in an MC-system.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; ASAM e.V.<br>
<cite>https://www.asam.net/standards/detail/mcd-2-mc/[ASAM MCD-2 MC]</cite>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_comments_about_this_approach">1.3. Comments about this Approach</h3>
<div class="paragraph">
<p><em>[This layered standard will have no effect on the FMU interface, nor the C-API behavior.</em>
<em>The XCP slave inside the FMU will most likely run in its own thread and leave the rest of the operation of the FMU unaffected.</em></p>
</div>
<div class="paragraph">
<p><em>The XCP/A2L approach can not only be used for virtual ECUs, but also for plant models, if the FMU exporter generates an appropriate <code>A2L</code> file.]</em></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_details">2. Details</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_structure_of_the_fmu_archive">2.1. Structure of the FMU archive</h3>
<div class="paragraph">
<p>A2L description files and other files needed for XCP support will be placed in the <code>extra</code> folder under the reverse domain name controlled by the MAP FMI: <code>/extra/org.modelica.fmi.layered_XCP</code>.
The folder structure is shown below.
Details are described in the following sections.</p>
</div>
<div id="figure-fmi-layered-XCP-folder-structure" class="listingblock">
<div class="content">
<pre>documentation
   layered_XCP{.txt,.html}          // Informal description how to use XCP/A2L for this FMU (optional).
extra/org.modelica.fmi.layered_XCP  // Contains files related to XCP/A2L
   &lt;modelIdentifier&gt;.a2l            // Variable description of a source code FMU (optional)
   x86_64-windows
      &lt;modelIdentifier&gt;.a2l         // Variable description for Windows on Intel 64-bit (optional)
   x86-linux
      &lt;modelIdentifier&gt;.a2l         // Variable description for Linux on Intel 32-bit (optional)
   aarch32-linux
      &lt;modelIdentifier&gt;.a2l         // Variable description for Linux on ARM 32-bit (optional)
   x86_64-darwin
      &lt;modelIdentifier&gt;.a2l         // Variable description for macOS (optional)</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_documentation">2.2. Documentation</h3>
<div class="paragraph">
<p>When shipping an FMU with XCP/A2L support, it is recommended to provide the necessary information for the consumer in the file <code>documentation/layered_XCP.{txt|html}</code>.
For example, this concerns information how to build the final A2L file, if the FMU is delivered as source code.</p>
</div>
</div>
<div class="sect2">
<h3 id="_a2l_description_files">2.3. A2L Description Files</h3>
<div class="paragraph">
<p>The <code>A2L</code> description depends on the FMU binary, for example, regarding memory addresses, and byte order.
If an FMU archive contains multiple binaries for different platforms, the associated A2L files are placed into separate subfolders below <code>/extra/org.modelica.fmi.layered_XCP</code> following the same scheme as in the <code>/binaries</code> folder, see <a href="#_structure_of_the_fmu_archive">Section 2.1</a>.</p>
</div>
<div class="paragraph">
<p><code>A2L</code> files may have a considerable size.
If size is a concern, it may be decided to supply just a single platform and <code>A2L</code> file with an FMU.</p>
</div>
<div class="paragraph">
<p>The root name of the A2L file shall be identical to the model identifier and is case sensitive, i.e. a variable description named <code>&lt;modelIdentifier&gt;.a2l</code> is associated with an FMU binary named <code>&lt;modelIdentifier&gt;.{dll,so}</code>.</p>
</div>
<div class="paragraph">
<p>All format versions of the <code>A2L</code> standard are allowed and it is the MCD tool&#8217;s responsibility to handle each format version correctly.</p>
</div>
<div class="paragraph">
<p>This standard forbids the use of the <code>including mechanism</code> of additional <code>A2L</code> files to simplify complete extraction and copying of the <code>A2L</code> file to a location where it is accessible by the MCD tool.</p>
</div>
<div class="paragraph">
<p>The addresses in the A2L file are relative to the base address of the FMU binary loaded in the simulator.
The XCP slave implementation is responsible for translating the addresses to the physical addresses needed to access the variable values.</p>
</div>
</div>
<div class="sect2">
<h3 id="_xcp_protocol_settings">2.4. XCP Protocol Settings</h3>
<div class="paragraph">
<p>The <code>A2L</code> description shall include <code>IF_DATA XCP</code> elements to help MCD tools to connect and interact with the XCP slave inside the FMU more reliably and without user interaction.
Parts of the <code>IF_DATA_XCP</code> description depend on the machine where the FMU binary is executed, for example, the IP address and port.</p>
</div>
<div class="paragraph">
<p>The default IP address used by the FMU exporter shall be <code>localhost</code>, i.e. <code>127.0.0.1</code>, which fits in many cases.
The requirement for the port number is, that it must be unique on the machine where the FMU binary is executed.
Typically, a certain range of ports is reserved for this purpose.
The FMU importer is responsible for checking if any conflicts of the defined IP addresses and port numbers occur in the context of the simulated system.</p>
</div>
<div class="paragraph">
<p>Sometimes it is necessary for the FMU importer to override the default IP address and/or port number which was assigned by the FMU exporter.
Therefore, the FMU model description shall contain two structural parameters which are used by the XCP slave during the configuration phase to setup the connection for the XCP protocol, see <a href="#_xcp_slave_implementation">Section 2.5</a>.</p>
</div>
<div id="figure-xcp-connection-parameters" class="listingblock">
<div class="title">XCP connection parameters</div>
<div class="content">
<pre>    IPAddress
        Description:  "IP address or host name of the machine where the FMU binary is executed"
        Type:         String
        Causality:    structuralParameter
        Variability:  fixed
        Start:        "127.0.0.1"

    XcpPortNumber
        Description:  "Port number where the XCP slave listens for XCP protocol commands"
        Type:         UInt16
        Causality:    structuralParameter
        Variability:  fixed
        Start:        &lt;in the range of 32768 to 39999&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>The consumer of an FMU is responsible for keeping all occurrences of the IP address and port number consistent, either by manual adjustment of the FMU model description and the A2L file, or with tool support.</p>
</div>
</div>
<div class="sect2">
<h3 id="_xcp_slave_implementation">2.5. XCP Slave Implementation</h3>
<div class="paragraph">
<p>Preferably, the XCP service shall be started during <code>fmi3ExitConfigurationMode</code> and shut down during <code>fmi3Terminate</code> if the FMU has no explicit power-up signal to simplify user interactions between simulator and MCD tool.
If the FMU contains a virtual ECU with power-up control (K15), all build in OS and Basic Software services (including XCP) should follow normal power-up protocol.
The XCP service must run after <code>fmi3EnterInitializationMode</code> at the latest.</p>
</div>
<div class="paragraph">
<p>If the simulator puts the FMU in <code>Configuration Mode</code> and sets the structural parameters <code>IPAddress</code> and <code>XcpPortNumber</code> (see <a href="#figure-xcp-connection-parameters">XCP connection parameters</a>), the XCP slave shall use those parameters to set up the communication connection for the XCP protocol.
After leaving <code>Configuration Mode</code> the XCP slave shall be responsive for XCP commands.
Thus, it is possible for the XCP master to perform calibration during the <code>Instantiated</code> state of the FMU, for example, to set parameters before entering <code>Initialization Mode</code>.
Note, that reading values of calculated variables, which depend on an initialization function is only possible after leaving the <code>Initialized</code> state with <code>fmi3ExitInitializationMode</code>.</p>
</div>
<div class="paragraph">
<p>If the XCP service is not started during <code>Configuration Mode</code>, because the simulator does not support structural parameters and therefore does not enter <code>Configuration Mode</code>, it must be started in <code>fmi3EnterInitializationMode</code> at the latest. In this case, it is not possible to perform calibration before the simulation is running.</p>
</div>
<div class="paragraph">
<p><em>[The A2L/XCP standards allow to measure variables synchronously to different types of events.</em>
<em>These so called measurement rasters are either time-based, angular-based, or non-deterministic, and are identified by a unique raster ID.</em>
<em>The XCP service must be invoked with the defined raster ID in the thread which is executed for an event.</em>
<em>Calibration and communication with the XCP master is typically performed in a background thread.</em>
<em>The background thread must always be responsive to the XCP master within the defined communication timeout.</em>
<em>Refer to the A2L/XCP standards for more information.</em></p>
</div>
<div class="paragraph">
<p><em>The implementation of the XCP slave inside the FMU shall only use calls of the host OS, which leave the behavior of the FMU unaffected.</em>
<em>This concerns, for example, host OS calls</em>
<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>
<em>needed for creation of an own background thread, or for resolving variable addresses relative to the base address of the loaded FMU binary.</em>
<em>Note, that blocking OS calls should be avoided, because they may have an effect on other parts of the simulator outside the FMU.</em></p>
</div>
<div class="paragraph">
<p><em><a href="#XCP-Communication-via-IP-Stack">Figure 1</a> shows a typical design where the XCP slave (in the FMU) communicates with the XCP master (in the MCD tool) using a separate network channel, e.g. the IP stack of the host OS.</em>
<em>Thus, the communication of the XCP service is not mixed with the simulated network communication of the ECU wrapped in the FMU.</em>
<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup></p>
</div>
<div class="paragraph">
<p><em><a href="#XCP-Communication-via-Virtual-ECU-COM-Stack">Figure 2</a> shows an alternative design where the XCP slave communicates via the COM stack of the virtual ECU as in a real ECU.</em>
<em>In this case, the simulator has to provide access to the simulated network communication for the MCD tool.</em>
<em>This design may be chosen if the XCP slave implementation is already part of a level-3 ECU code to be tested.</em>
<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup>
]</p>
</div>
<div id="XCP-Communication-via-IP-Stack" class="imageblock text-center">
<div class="content">
<img src="images/XCP-Communication-via-IP-Stack.svg" alt="XCP Communication via IP Stack" width="80%">
</div>
<div class="title">Figure 1. Direct communication of XCP master and XCP slave via the IP stack of the host OS</div>
</div>
<div id="XCP-Communication-via-Virtual-ECU-COM-Stack" class="imageblock text-center">
<div class="content">
<img src="images/XCP-Communication-via-Virtual-ECU-COM-Stack.svg" alt="XCP Communication via Virtual ECU COM Stack" width="80%">
</div>
<div class="title">Figure 2. Communication of XCP master and XCP slave via the COM stack of the virtual ECU</div>
</div>
</div>
<div class="sect2">
<h3 id="_source_code_fmus">2.6. Source Code FMUs</h3>
<div class="paragraph">
<p>For the special case when an FMU is delivered as target-independent source code (possibly with some libraries), a <code>raw A2L fragment</code> is placed directly into the <code>/extra/org.modelica.fmi.layered_XCP</code> folder.
The <code>raw A2L fragment</code> of a source code FMU is necessarily incomplete, because the details of the A2L description depend on the binary for the target platform, for example, regarding memory addresses, alignments, checksums, etc.</p>
</div>
<div class="paragraph">
<p>In the case of source code FMUs, the FMU exporter is responsible for providing the implementation of the XCP slave module.
The XCP slave must be invoked in the FMU code according to the defined measurement rasters and in the background as described in <a href="#_xcp_slave_implementation">Section 2.5</a>.</p>
</div>
<div class="paragraph">
<p>The FMU importer is responsible for building the FMU binary and creating the final A2L file by adjusting platform dependent information in the <code>raw A2L fragment</code>.
This concerns memory addresses, alignments, checksums, <code>IF_DATA_XCP</code> elements, etc.</p>
</div>
<div class="paragraph">
<p>If additional information for the build process and A2L creation is required, it should be provided by the FMU exporter in <code>documentation/layered_XCP.{txt|html}</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_variable_visibility">2.7. Variable Visibility</h3>
<div class="paragraph">
<p>The <code>modelDescription.xml</code> file publishes a certain set of variables and parameters.
The <code>A2L</code> file also publishes a set of FMU variables and parameters.
This standard expressly does not restrict the relationship between both sets of variables.</p>
</div>
<div class="paragraph">
<p><em>[As a matter of fact, it is quite likely that the variables published in <code>modelDescription.xml</code> is a minimal set required for connectivity reasons.</em>
<em>The <code>A2L</code> file might publish a much larger set of variables and parameters that the user can selectively choose to measure or calibrate.</em></p>
</div>
<div class="paragraph">
<p><em>Note, that normally only variables in the memory segments owned by the main FMU binary <code>{.dll, .so}</code> are accessible by the XCP service, i.e. variables defined in source code modules and in statically linked libraries.</em>
<em>Accessing variables in the memory of indirectly loaded dynamic libraries requires a special implementation which is out-of-scope for this layered standard.</em>
<em>From the viewpoint of an MCD tool, the details of the variable access are transparent, i.e. this information is encapsulated in the A2L file.]</em></p>
</div>
</div>
<div class="sect2">
<h3 id="_numeric_effects_of_xcp_access">2.8. Numeric Effects of XCP Access</h3>
<div class="paragraph">
<p>While measurement of FMU internal variables does not have a numeric effect on the FMU, so called calibration does.
Calibration is the tuning of FMU internal parameters.
Such changes will affect the numeric behavior of the FMU.
If the FMU contains controller code, numeric stability or energy preservation laws are of lesser concern.
On the other hand, plant models offering XCP access for parameter calibration may introduce surprising numerical effects in solvers that might require proper handling, like resetting solvers with every XCP write action.</p>
</div>
<div class="paragraph">
<p>It is therefore necessary to synchronize XCP variable access (read and write) with the state of the FMU.
<em>[For instance is time not linear in Model Exchange and Intermediate Variable Access might also introduce surprising measurements in Co-Simulation.</em>
<em>Appropriate care must be taken when to serve XCP master requests to ensure simulation and measurement integrity.]</em></p>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. The term 'host OS' means the OS where the FMU process is executed. This could even be the OS inside a virtual machine connected to the simulator.
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. The network communication of FMUs is described by another layered standard. The details of network communication are out of scope here.
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. The same design could be used to access a diagnostic service, if it is implemented by the ECU code inside the FMU.
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/highlight.min.js"></script>
<script>
if (!hljs.initHighlighting.called) {
  hljs.initHighlighting.called = true
  ;[].slice.call(document.querySelectorAll('pre.highlight > code')).forEach(function (el) { hljs.highlightBlock(el) })
}
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>